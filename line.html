<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Line Chart Produksi Tanaman</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid container">
        <a class="navbar-brand" href="#">Produksi Tanaman</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Bar Chart</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="line.html">Line Chart</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="bubble.html"
                >Bubble Chart</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="maps.html"
                >Map Chart</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <div class="alert alert-info">
        <strong>Tips:</strong> Line chart ini menunjukkan perkembangan produksi
        dari tahun 2022-2024. Anda bisa memfilter berdasarkan provinsi atau
        jenis tanaman tertentu.
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <label for="provinsi" class="form-label">Pilih Provinsi:</label>
          <select id="provinsi" class="form-select" onchange="updateChart()">
            <option value="all">Semua Provinsi</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="jenis_tanaman" class="form-label"
            >Pilih Jenis Tanaman:</label
          >
          <select
            id="jenis_tanaman"
            class="form-select"
            onchange="updateChart()"
          >
            <option value="all">Semua Jenis Tanaman</option>
          </select>
        </div>
      </div>

      <div id="lineChart" class="mt-4 mb-4" style="height: 600px"></div>
    </div>

    <script>
      /**
       * Loads and parses CSV data into JSON format.
       * @returns {Promise<Object[]>} Parsed data array
       */
      async function loadData() {
        const response = await fetch("plotly_data_long.csv");
        const data = await response.text();
        const rows = data.split("\n").map((row) => row.split(","));
        const headers = rows[0];

        const dataArr = rows.slice(1).map((row) => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = row[idx];
          });
          return obj;
        });

        return dataArr;
      }

      /**
       * Initializes filter dropdowns for province and plant type.
       */
      async function loadFilters() {
        const data = await loadData();

        const provinsiSet = new Set(
          data
            .map((item) => item["Provinsi"])
            .filter((provinsi) => provinsi.trim() !== "")
        );

        const provinsiSelect = document.getElementById("provinsi");
        Array.from(provinsiSet)
          .sort()
          .forEach((provinsi) => {
            const option = document.createElement("option");
            option.value = provinsi;
            option.textContent = provinsi;
            provinsiSelect.appendChild(option);
          });

        const jenisTanamanSet = new Set(
          data.map((item) => item["Jenis Tanaman"])
        );
        const jenisTanamanSelect = document.getElementById("jenis_tanaman");
        Array.from(jenisTanamanSet)
          .sort()
          .forEach((jenis) => {
            const option = document.createElement("option");
            option.value = jenis;
            option.textContent = jenis;
            jenisTanamanSelect.appendChild(option);
          });
      }

      /**
       * Updates and renders the line chart based on selected filters.
       */
      async function updateChart() {
        const data = await loadData();
        const selectedProvinsi = document.getElementById("provinsi").value;
        const selectedJenisTanaman =
          document.getElementById("jenis_tanaman").value;

        // Filter data berdasarkan pilihan
        const filteredData = data.filter((item) => {
          const isValidProvinsi = item["Provinsi"].trim() !== "";
          const matchProvinsi =
            selectedProvinsi === "all" || item["Provinsi"] === selectedProvinsi;
          const matchTanaman =
            selectedJenisTanaman === "all" ||
            item["Jenis Tanaman"] === selectedJenisTanaman;
          return isValidProvinsi && matchProvinsi && matchTanaman;
        });

        // Group data untuk line chart
        const groupedData = {};

        filteredData.forEach((item) => {
          const key =
            selectedProvinsi === "all"
              ? item["Provinsi"]
              : item["Jenis Tanaman"];

          if (!groupedData[key]) {
            groupedData[key] = {
              2022: 0,
              2023: 0,
              2024: 0,
            };
          }
          groupedData[key][item["Tahun"]] += parseFloat(item["Produksi"]);
        });

        // Siapkan traces untuk Plotly
        const traces = [];
        const colors = [
          "#1f77b4",
          "#ff7f0e",
          "#2ca02c",
          "#d62728",
          "#9467bd",
          "#8c564b",
          "#e377c2",
          "#7f7f7f",
          "#bcbd22",
          "#17becf",
        ];

        let colorIndex = 0;
        for (const [name, values] of Object.entries(groupedData)) {
          traces.push({
            x: ["2022", "2023", "2024"],
            y: [values["2022"], values["2023"], values["2024"]],
            name: name,
            type: "line",
            mode: "lines+markers",
            marker: {
              size: 8,
              color: colors[colorIndex % colors.length],
            },
            line: {
              width: 3,
              color: colors[colorIndex % colors.length],
            },
          });
          colorIndex++;
        }

        // Atur layout
        const layout = {
          title: `Tren Produksi ${
            selectedJenisTanaman === "all"
              ? "Semua Jenis Tanaman"
              : selectedJenisTanaman
          } 
                  di ${
                    selectedProvinsi === "all"
                      ? "Semua Provinsi"
                      : selectedProvinsi
                  }`,
          xaxis: {
            title: "Tahun",
            type: "category",
          },
          yaxis: {
            title: "Produksi (kw)",
          },
          hovermode: "closest",
          showlegend: true,
          legend: {
            orientation: "h",
            y: -0.2,
          },
          margin: {
            l: 50,
            r: 50,
            b: 100,
            t: 50,
            pad: 4,
          },
        };

        Plotly.newPlot("lineChart", traces, layout);
      }

      // Inisialisasi dashboard saat pertama kali dimuat
      document.addEventListener("DOMContentLoaded", () => {
        loadFilters().then(() => updateChart());
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
  </body>
</html>
